#  렌더링 과정

파싱( 구문 분석 )은 프로그래밍 언어의 문법에 맞게 작성된 텍스트 문서를 읽어 들여 실행하기 위해서 텍스트 문서의 문자열을 토큰으로 분해하여 토큰에 문법적 의미와 구조를 반영하여 트리 구조의 자료 구조인 파스트리를 생성하는 일련의 과정을 말한다. 브라우저의 랜더링 과정은 다음과 같다

1. 브라우저는 html, css, 자바스크립트, 이미지, 폰트 파일 등의 렌더링에 필요한 리소스를 요청하고 서버로 부터 응답을 받는다.
2. 브라우저의 렌더링 엔진은 서버로 부터 응답된 자바스크립트를 파싱하여 AST를 생성하고 바이트 코드로 변환하여 실행한다. 이때 자바스크립트는 DOM API를 통해서 DOM, CSSOM을 변경할 수 있다.
3. 랜더 트리를 기반으로 HTML 요소의 레이아웃을 계산하고 브라우저 화면에 페인팅한다.

## 요청과 응답

브라우저의 핵심은 리소르를 서버에서 요청하여 응답을 받아 브라우저에 시각적으로 랜더링하는 것이다.  즉 소스는 서버에 존재하므로 소스를 서버에 요청하여 응답한 리소스를 파싱하여 랜더링한다.

서버에 요청하기 위해서 브라우저는 주소창을 제공한다. 주소창에 url을 입력하고 엔터키를 누르면 URL의 호스트이름은 DNS를 통해서 IP주소로 변환되고 이 IP주소를 갖는 서버에게 요청을 전송한다. 



## HTTP1.1과 HTTP2.0

HTTP는 웹에서 브라우저와 서버간의 통신을 하기 위한 프로토콜이다. 1.1은 기본적으로 연결 당 하나의 요청과 응답만을 처리한다. 때문에 여러 요청을 한번에 처리할 수 없고 응답도 한번에 여러 가지를 할 수 없다. 따라서 HTML문서의 여러 소스 요청이 개별적으로 요청 응답이 된다. 즉 리소스가 많을 수록 응답시간도 늘어났다.

2.0은 1.1과는 달리 연결 당 여러 개의 요청과 응답이 가능하다. 1.1보다 50% 정도 빠르다고 한다.



## HTML파싱과 DOM생성

브라우저의 요청에 의해서 서버가 응답한 HTML문서는 문자열로 이루어진 순수 텍스트 파일이다.  이 텍스트파일을 브라우저가 읽을 수 있는 자료구조로 변환하여 저장해야한다.

브라우저는 바이트 > 문자 > 토큰 > 노드 > DOM순으로 파싱한다.

1. 서버에 존재하던 HTML파일이 브라우저 요청에 의해서 응답된다. 이때 서버는 요청된 HTML파일을 읽어들여 메모리에 2진수 바이트로 저장하고 인터넷을 통해 응답한다.
2. 브라우저는 서버가 응답해준 바이트 HTML의 문서를 받아 문자열로 변환된다.
3. 문자열로 변환된 html문서를 읽어들여 문법적 의미를 갖는 토큰들로 분해한다.
4. 토큰들을 객체화 하여 노드를 생성한다. 노드의 종류에는 문서, 요소, 어트리부트.텍스트 노드가 생성된다.
5. html문서는 html요소들의 집합으로 html요소는 중첩관계를 갖는다. 이런 관게를 부자관계라 할 수 있고, 이 관계를 반영하여 트리구조의 자료 구조를 만드는 데 이 결과물을 DOM이라고 한다.

## CSS파싱과 CSSOM 생성

랜더링 엔진은 html을 처음부터 한 줄씩 순차적으로 파싱하여 DOM을 만든다. 이렇게 한 줄씩 DOM을 만들다가 css를 로드하는 link태그나 style태그를 만나면 DOM생성을 잠시 멈춘다.

그리고 href어트리뷰트에 정의 된 파일을 서버에 요청하여 응답받은 파일을 html과 동일한 파싱과정으로 CSSOM을 생성한다. css 파싱을 완료하면 html파싱이 중단된 지점부터 다시 DOM을 생성해 나간다.



## 렌더 트리 생성

렌더링 엔진은 서버로 부터 응답된 HTML과 CSS를 파싱하여 DOM과 CSSOM을 생성한다. 그리고 DOM과 CSSOM은 랜더링을 위해서 랜더 트리로 결합된다. 결합되어 만들어진 랜더 트리는 레이아웃 계산에 사용되며 브라우저 화면에 픽셀을 렌더링하는 페인팅처리에 입력된다.

브라우저의 렌더링 과정은 반복해서 실행 될 수 있다. 예를 들어 레이아웃 계산과 페인팅 과정이 재차 실행될 수 있는데 자바스크립트에 의한 노드 추가삭제, 브라우저 윈도우 리사이징에 의한 뷰포트 크기변경, html요소의 레이아웃의 변경을 일으키는 css스타일 변경 등 의 요인으로 레이아웃 계산과 페인팅 과정이 다시 실행된다. 그러나 이런 리렌더링은 비용이 많이 드는 작업이기 때문에 리렌더링을 빈번하게 사용하는 것은 좋지 않다.

## 자바스크립트 파싱과 실행

HTML문서를 파싱한 결과물로 만들어진 DOM은 HTML문서의 구조와 정보 뿐 아니라 HTML요소와 스타일 등을 변경 할 수 있는 프로그래밍 인터페이스로서 DOM API를 제공한다. 즉 자바스크립트 코드에서 DOM API를 사용하면 이미 생성된 DOM을 동적으로 조작 가능하다.

CSS 파싱과 마찬가지로 렌더링 엔진은 HTML을 한 줄씩 순차적으로 파싱하여 DOM을 생성하다 자바스크립트를 로드하는 SCRIPT태그나 태그 내부에 자바스크립트 코드를 담고 있는 SCRIPT태그를 만나면 DOM의 생성을 멈춘다. 

SRC 어트리뷰트에 정의 된 파일을 서버에 요청하여 응답으로 받아 자바스크립트 코드의 파싱을 위해서 자바스크립트 엔진에 제어권을 넘긴다. 이후 CSS와 같이 끝나면 DOM을 다시 생성한다. 자바스크립트 파싱은 자바스크립트 엔진이 처리한다. 

브라우저 렌더링 엔진으로 부터 제어권을 넘겨받은 자바스크립트 엔진은 자바스크립트 코드를 파싱하기 시작하는데, HTML과 CSS가 각각의 객체 모델을 만들었 듯이 자바스크립트도 AST라는 추상적 구문 트리를 생성한다. 이 AST를 기반으로 인터프리터가 실행할 수 있는 중간 코드인 바이트 코드를 생성하여 실행한다.

브라우징![img](https://poiemaweb.com/assets/fs-images/38-10.png)

토크 나이징 - 문자열을 문법적 의미를 갖는 코드의 최소 단위인 토큰으로 분해한다.

파싱 - 토큰들의 집합을 구문 분석하여 AST를 생성한다. 이 AST는 인터프리터가 사용할 것이다.

바이트 코드 생성과 실행 - 파싱을 통해서 만들어진 AST는 인터프리터가 사용할 수 있게 다시 바이트코드로 변환되고 인터프리터에 의해서 실행된다.



## 리플로우와 리페인트

만약 자바스크립트 코드에서 DOM이나 CSSOM을 변경하는 DOM API가 사용되면 DOM과 CSSOM의 변화가 일어나는데, 변경된 DOM,CSSOM은 다시 렌더트리로 결합되고 변경된 렌더 트리를 기반으로 레이아웃과 페인트 과정을 거친 후에 브라우저에 렌더링된다. 

DOM,CSSOM의 변경에 의해서 다시 만들어진 렌더 트리가 다시 레이아웃 계산을 하는 것을 리플로우라 하며, 재결합된 렌더 트리가 페인트 과정을 거치는 것을 리페인트라고 한다. 단 이 두 과정이 반드시 순차적으로 동시에 일어나는 것은 아니다. 레이아웃에 영향이 없는 변경은 리 페인트만 실행된다.

## 자바스크립트 파싱에 의한 HTML파싱중단

브라우저는 동기적으로 파싱을 한다. 이것은 SCRIPT태그의 위치에 따라서 HTML파싱이 막혀 DOM생성이 지연 되 수 있다는 것을 의미하고 때문에 SCRIPT 태그의 위치는 중요한 의미를 갖는다. 만약 SCRIPT태그가 BODY보다 상위에 있을 경우에 자바스크립트 코드에서 DOM API를 사용할 일이 있다면 그 코드는 DOM의 생성이 완료되어야 실행이 된다. 하지만 DOM의 생성이 완료되지 않은 상태라면 문제가 발생할 수 있다.

이런 문제의 회피방법으로 SCRIPT태그를 BODY태그의 가장 마지막에 사용하는 방법이 있다. 이 방법을 사용하면 페이지 로딩시간도 단축되고 자바스크립트의 코드가 DOM을 제어하는 것에 문제가 생기지 않는다.


## SCRIPT태그의 ASYNC / DEFER 어트리뷰트

앞서 본 자바스크립트 파싱에 의한 DOM 생성이 중단 되는 문제를 근본적으로 해결하기 위해서 HTML5부터 script태그에 어트리뷰트가 추가되었다. 이는 async와 defer로 사용을 위해선 자바스크립트에 src속성이 존재해야 한다. 이 어트리뷰트는 html의 파싱과 외부 자바스크립트 파일의 로드를 비동기 적으로 진행시켜 준다. 

1. async어트리뷰트

   html파싱과 외부 자바스크립트 파일의 로드가 비동기적으로 진행되며 자바스크립트의 파싱과 실행은 자바스크립트 로드가 완료된 직후 진행되며 이때 html파싱이 중단된다. 이 어트리뷰트는 순서가 보장되지 않음으로 순서 보장이 필요한 script태그는 asynce 어트리뷰트를 사용하지 않아야한다.

2. defer 어트리뷰트

   html파싱과 외부 자바스크립트 파일의 로드가 비동기적으로 진행되지만 async와는 다르게 자바스크립트 파일의 실행을 html 파싱이 끝나 DOM이 생성된 직후에 진행된다. DOM이 생성이 되면 DOMContentLoaded이벤트가 발생하는데 이 시정에 자바스크립트가 실행됨으로 유용하다.